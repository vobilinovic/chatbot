<!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Simulador WhatsApp</title>
</head>
<body>

    <div class="phone">
        
        <div class="header">
            <i class="fa-solid fa-arrow-left"></i>
            <img src="DAP-Isotipo_FondoBlanco.png" class="imagen" style="width: 50px;"/>
            <p class="texto">SMS DAP</p>
        </div>
        <div class="chat" id="chat"></div>

        <div class="input">
            
            <input id="text" placeholder="Mensaje" />
            <button onclick="send()">‚û§</button>
        </div>
    </div>

    <script>
        const chat = document.getElementById("chat");
        const inputField = document.getElementById("text");
        

        let state = {
            step: 0,
            categoria: "",
            area: "",
            subBloque: "",
            data: {} // Aqu√≠ se guardan todas las respuestas
        };

        // --- FUNCIONES DE UTILIDAD (UI) ---

        function scrollToBottom() {
            chat.scrollTop = chat.scrollHeight;
        }

        function addMsg(text, type) {
            const div = document.createElement("div");
            div.className = "msg " + type;
            div.innerHTML = text; // Permite HTML como <br> o <b>
            chat.appendChild(div);
            scrollToBottom();
        }

        // Esta funci√≥n reemplaza toda la repetici√≥n de crear botones manualmente
        function showOptions(options) {
            const div = document.createElement("div");
            div.className = "msg bot options";
            
            options.forEach(opt => {
                const btn = document.createElement("button");
                // Si opt es string, √∫salo como etiqueta y valor. Si es objeto, separa label y valor.
                const label = typeof opt === 'string' ? opt : opt.label;
                const val = typeof opt === 'string' ? opt : opt.val;
                
                btn.innerHTML = label;
                btn.onclick = () => handleInput(val, true); // true indica que vino de un bot√≥n
                div.appendChild(btn);
            });
            
            chat.appendChild(div);
            scrollToBottom();
        }

        // Simula el "Escribiendo..." y luego muestra el mensaje y opciones
        function botTalk(text, options = null, delay = 500) {
            setTimeout(() => {
                addMsg(text, "bot");
                if (options) {
                    showOptions(options);
                }
            }, delay);
        }

        // --- L√ìGICA PRINCIPAL DEL FLUJO ---

        function start() {
            botTalk("Hola. Gracias por comunicarte con nosotros.<br>¬øQu√© tipo de evento desea reportar?", 
                ["<b>Ocurrencia:</b> Evento ocurrido con da√±o o impacto real.", 
                "<b>Incidente:</b> Evento ocurrido sin consecuencias graves.", 
                "<b>Near Miss:</b> Accidente que estuvo a punto de ocurrir.", 
                "<b>Peligro:</b> Riesgo latente que a√∫n no se materializa.", 
                "<b>Mejora:</b> Propuesta para fortalecer la seguridad."]);
            state.step = 1;
        }

        // Esta funci√≥n maneja TODAS las entradas (texto o botones)
        function handleInput(text, isButton = false) {
            if (!text) return;
            
            // Mostrar mensaje del usuario
            addMsg(text, "user");
            if (!isButton) inputField.value = "";

            // Guardar respuesta en el objeto data
            state.data[`Paso_${state.step}`] = text;

            switch (state.step) {
                case 1: // Selecci√≥n de Categor√≠a
                    state.categoria = text;
                    let msgContexto = "";
                    if (text === "Ocurrencia") {
                        msgContexto = "Est√°s a punto de reportar una <b>OCURRENCIA</b>.<br>Es un evento real con consecuencias concretas.";
                    } else if (text === "Incidente") {
                        msgContexto = "Est√°s a punto de reportar un <b>INCIDENTE</b>.<br>Evento que no produjo consecuencias graves pero afect√≥ la seguridad.";
                    } else if(text === "Near Miss"){
                        msgContexto = "Est√°s a punto de reportar un <b>NEAR MISS</b>.<br>Evento que estuvo a punto de convertirse en un accidente.";
                    } else if(text === "Peligro"){
                        msgContexto = "Est√°s a punto de reportar un <b>PELIGRO</b>.<br>Riesgo latente que a√∫n no se ha materializado.";
                    } else if(text === "Mejora"){
                        msgContexto = "Est√°s a punto de reportar una <b>MEJORA</b>.<br>Propuesta para fortalecer la seguridad operacional.";
                    }
                    
                    botTalk(msgContexto, null, 400); 
                    state.step = 2;
                    botTalk("¬øA qu√© departamento pertenece el reporte?", [
                        "Aerov√≠as DAP ‚Äì Operaciones", "Aerov√≠as DAP ‚Äì Aeropuerto", 
                        "Aerov√≠as DAP ‚Äì Mantenimiento", "DAP Helic√≥pteros ‚Äì Operaciones",
                        "DAP Helic√≥pteros ‚Äì Mantenimiento", "Otra √°rea"
                    ], 1000);
                    break;

                case 2: // √Årea Principal
                    state.step = 3;
                    botTalk("√Årea principal involucrada:", [
                        "Operaciones", "Mantenimiento", "Handling / Rampa", 
                        "Ingenier√≠a", "Despacho / OCC", "SMS / Calidad", "Otra"
                    ]);
                    break;

                case 3: // Decisi√≥n: ¬øBloque Operacional o Descripci√≥n?
                    state.area = text;
                    // REGLA: Si es Ops o Manto -> Bloque Operacional (Paso 4)
                    // Si NO -> Saltamos directo a pedir descripci√≥n y configuramos el paso 11 (que espera la respuesta)
                    if (text.includes("Operaciones") || text.includes("Mantenimiento")) {
                        if(state.categoria === "<b>Peligro:</b> Riesgo latente que a√∫n no se materializa."){
                            //PENDIENTE
                        }else{
                            state.step = 4;
                            botTalk("Ingrese la Fecha del evento (DD/MM/AAAA):"); 
                        }
                        
                    } else{
                        if(state.categoria === "<b>Peligro:</b> Riesgo latente que a√∫n no se materializa."){
                            state.step = 130;
                            botTalk("Lugar donde se identifica el peligro", [
                            "Aer√≥dromo / Base operacional", "Plataforma", "Pista", "Calle de rodaje", "Hangar", "Instalaciones CMA", "En ruta", "Otro (especificar)"]);
                        }else{
                            state.step = 11; // <--- CAMBIO CLAVE: Saltamos al paso que RECIBE la descripci√≥n
                            botTalk("<b>Descripci√≥n:</b> Indique qu√© ocurri√≥ detalladamente.");
                        }
                        
                    }
                    break;

                // --- BLOQUE OPERACIONAL (Com√∫n) ---
                case 4: // Fecha -> Hora
                    state.step = 5;
                    botTalk("Hora del evento (UTC):");
                    break;
                case 5: // Hora -> AD Salida
                    state.step = 6;
                    botTalk("Aer√≥dromo de salida (AP/AD):");
                    break;
                case 6: // AD Salida -> AD Llegada
                    state.step = 7;
                    botTalk("Aer√≥dromo de llegada (AP/AD):");
                    break;
                case 7: // AD Llegada -> Fase Vuelo
                    state.step = 8;
                    botTalk("Fase de vuelo:", [
                        "Estacionamiento", "Rodaje Salida", "Despegue", "Ascenso", 
                        "Crucero", "Descenso", "Aproximaci√≥n", "Aterrizaje", "Post-vuelo"
                    ]);
                    break;
                case 8: // Fase -> Lugar
                    state.step = 9;
                    botTalk("Lugar donde ocurri√≥:", [
                        "Plataforma", "Pista", "Calle de rodaje", "En ruta", 
                        "Hangar", "Instalaciones CMA", "Otro"
                    ]);
                    break;
                case 9: // Lugar -> Matr√≠cula
                    state.step = 10;
                    botTalk("Matr√≠cula de la aeronave:", ["CC-ACN", "CC-ACO", "CC-ACQ", "Otra"]);
                    break;

                // --- UNIFICACI√ìN ---
                case 10: // Recibe Matr√≠cula -> Pide Descripci√≥n
                    // Este paso solo se ejecuta si vinimos por el camino largo (Bloque Operacional)
                    state.step = 11;
                    botTalk("<b>Descripci√≥n:</b> Indique qu√© ocurri√≥, c√≥mo se desarroll√≥ y antecedentes relevantes.");
                    break;

                case 11: // Recibe Descripci√≥n -> RAMIFICACI√ìN
                    // Aqu√≠ llega el usuario que escribi√≥ "test".
                    // Ya tenemos la descripci√≥n, ahora decidimos qu√© sigue seg√∫n Ocurrencia o Incidente.
                    console.log(state.categoria)
                    if (state.categoria === "<b>Incidente:</b> Evento ocurrido sin consecuencias graves.") {
                        // CAMINO INCIDENTE
                        state.step = 30; 
                        botTalk("Tipo de situaci√≥n involucrada:", [
                            "Configuraci√≥n incorrecta", "Error en procedimiento", 
                            "Falla t√©cnica", "Problema comunicaci√≥n", "Condici√≥n insegura"
                        ]);
                    } else if(state.categoria === "<b>Ocurrencia:</b> Evento ocurrido con da√±o o impacto real."){
                        // CAMINO OCURRENCIA
                        state.step = 12;
                        botTalk("¬øHubo personas lesionadas?", ["S√≠", "No"]);
                    }else if(state.categoria === "<b>Near Miss:</b> Accidente que estuvo a punto de ocurrir."){
                        state.step = 55;
                        botTalk("¬øQu√© ACCIDENTE podr√≠a haber ocurrido?", 
                        ["Colisi√≥n / impacto", "P√©rdida de control", "Incursi√≥n en pista", "Da√±o estructural a la aeronave", "Lesi√≥n a personas", "Otro"]);
                    }else if(state.categoria === "<b>Peligro:</b> Riesgo latente que a√∫n no se materializa."){
                        
                    }
                    break;

                // --- CAMINO OCURRENCIA: CONSECUENCIAS ---
                case 12: // ¬øLesionados?
                    if (text === "S√≠") {
                        state.step = 13;
                        botTalk("Gravedad de las lesiones:", ["Leve", "Grave", "Fatal"]);
                    } else {
                        state.step = 14;
                        botTalk("¬øHubo da√±os materiales?", ["S√≠", "No"]);
                    }
                    break;
                case 13: // Gravedad -> Da√±os
                    state.step = 14;
                    botTalk("¬øHubo da√±os materiales?", ["S√≠", "No"]);
                    break;
                case 14: // ¬øDa√±os?
                    if (text === "S√≠") {
                        state.step = 15;
                        botTalk("Tipo de da√±o material:", ["Aeronave", "Infraestructura", "Equipos", "Otro"]);
                    } else {
                        goToRiskAssessment(); 
                    }
                    break;
                case 15: // Tipo da√±o -> Riesgo
                    goToRiskAssessment();
                    break;

                // --- CAMINO INCIDENTE: DETECCI√ìN Y BARRERAS ---
                case 30: // Situaci√≥n -> Factor
                    state.step = 31;
                    botTalk("Factor principal involucrado (a su juicio):", [
                        "Factor humano", "Factor t√©cnico", "Factor organizacional", 
                        "Condiciones ambientales", "No estoy seguro"
                    ]);
                    break;
                case 31: // Factor -> Etapa
                    state.step = 32;
                    botTalk("Etapa en la que se produjo:", [
                        "Antes de la operaci√≥n", "Durante la operaci√≥n", "Despu√©s de la operaci√≥n"
                    ]);
                    break;
                case 32: // Etapa -> Desviaci√≥n
                    state.step = 33;
                    botTalk("¬øHubo desviaci√≥n de procedimientos?", ["S√≠", "No", "No estoy seguro"]);
                    break;
                case 33: // Desviaci√≥n -> Detecci√≥n
                    state.step = 34;
                    botTalk("¬øC√≥mo fue detectado el incidente?", [
                        "Autodetecci√≥n", "Otro miembro equipo", "Sistema/Alarma", "Auditor√≠a"
                    ]);
                    break;
                case 34: // Detecci√≥n -> Barreras
                    state.step = 35;
                    botTalk("¬øQu√© evit√≥ que el incidente escalara?", [
                        "Procedimiento", "Experiencia personal", "Sistema t√©cnico", 
                        "Comunicaci√≥n efectiva", "Suerte/Azar"
                    ]);
                    break;
                case 35: // Barreras -> Lesiones (Verificaci√≥n)
                    state.step = 12; // Reutilizamos l√≥gica de Ocurrencia para lesiones
                    botTalk("¬øHubo personas lesionadas (aunque sean leves)?", ["S√≠", "No"]);
                    break;


                // --- EVALUACI√ìN DE RIESGO (Final) ---
                case 40: // Probabilidad -> Severidad
                    state.step = 41;
                    botTalk("Si este evento se repite, ¬øqu√© nivel de consecuencia podr√≠a tener?", 
                        ["Sin impacto", "Impacto menor", "Impacto mayor", "Grave"]);
                    break;
                case 41: // Severidad -> Urgencia
                    state.step = 42;
                    botTalk("¬øConsidera que requiere acci√≥n inmediata?", ["S√≠", "No", "No s√©"]);
                    break;
                case 42: // Urgencia -> Propuesta
                    state.step = 43;
                    botTalk("¬øQu√© acci√≥n ayudar√≠a a evitar que esto se repita? (Opcional)");
                    break;
                case 43: // Propuesta -> Cierre
                    state.step = 44;
                    botTalk("¬øEl evento fue informado a jefatura?", ["S√≠", "No"]);
                    break;
                case 44: // Fin
                    state.step = 99;
                    botTalk("<b>REPORTE FINALIZADO</b><br>Gracias por tu reporte. Identificar incidentes permite fortalecer las barreras de seguridad y prevenir eventos de mayor gravedad.");
                    console.log("Datos:", state.data);
                    break;

                //NEAR MISS
                case 55:
                    state.step = 56;
                    botTalk("La situaci√≥n de riesgo estuvo asociada principalmente a:", 
                    ["Aves (riesgo aviario)", "Objeto en pista / FOD", "Fauna terrestre", "Tr√°fico a√©reo / separaci√≥n", "Condiciones meteorol√≥gicas", "Otro"]);
                    break;

                case 56:      
                    let situacion = state.data['Paso_56'];
                    if(situacion === "Aves (riesgo aviario)"){
                        state.step = 57;
                        botTalk("Fase espec√≠fica donde se observ√≥ la(s) ave(s):", 
                        ["Rodaje", "Carrera de despegue", "Post-despegue", "Aproximaci√≥n", "Aterrizaje", "En Ruta"]);
                    }else if(situacion === "Objeto en pista / FOD"){
                        state.step = 60;
                        botTalk("Tipo de objeto:", 
                        ["Herramienta", "Parte met√°lica", "Pl√°stico", "Otro"]);
                    }else if(situacion === "Fauna terrestre"){
                        state.step = 63;
                        botTalk("Tipo de fauna:", 
                        ["Ave grande", "Mam√≠fero peque√±o", "Mam√≠fero grande", "No identificado"]);
                    }else if(situacion === "Tr√°fico a√©reo / separaci√≥n"){
                        state.step = 65;
                        botTalk("Situaci√≥n:", 
                        ["Separaci√≥n reducida", "Autorizaci√≥n confusa", "Tr√°fico no esperado", "Otro"]);
                    }else if(situacion === "Condiciones meteorol√≥gicas"){
                        state.step = 67;
                        botTalk("Condici√≥n predominante:", 
                        ["Viento", "Cizalladura", "Precipitaci√≥n", "Visibilidad", "Hielo"]);
                    }
                    break;

                //riesgo aviario
                case 57:
                    state.step = 58;
                    botTalk("Cantidad aproximada:", 
                    ["Una", "Varias (2-10)", "Bandada (> 10)", "No seguro"]);
                    break;

                case 58:
                    state.step = 59;
                    botTalk("Proximidad al impacto:", 
                    ["Muy cercana", "Cercana", "Con margen"]);
                    break;

                case 59:
                    state.step = 110;
                    botTalk("Control del riesgo aviario en el lugar:", 
                    ["Adecuado", "Parcial", "Deficiente", "No lo s√©"]);
                    break;

                //fod objeto en pista
                case 60:
                    state.step = 61;
                    botTalk("Lugar:", 
                    ["Pista", "Calle de rodaje", "Plataforma", "√Årea mantenimiento"]);
                    break;

                case 61:
                    state.step = 62;
                    botTalk("C√≥mo se detect√≥:", 
                    ["Visual", "ATC", "Inspecci√≥n", "Casualidad"]);
                    break;

                case 62:
                    state.step = 110;
                    botTalk("Repetici√≥n en el lugar:", 
                    ["Frecuente", "Ha ocurrido", "Primera vez", "No lo s√©"]);
                    break;

                //fauna terrestre
                case 63:
                    state.step = 64;
                    botTalk("Ubicaci√≥n:", 
                    ["Pista", "Calle de rodaje", "Per√≠metro", "Plataforma"]);
                    break;

                case 64:
                    state.step = 110;
                    botTalk("Control existente:", 
                    ["Adecuado", "Parcial", "Deficiente", "No lo s√©"]);
                    break;

                //trafico aereo/separacion
                case 65:
                    state.step = 66;
                    botTalk("Fase:", 
                    ["Rodaje", "Despegue", "Aproximaci√≥n", "En ruta"]);
                    break;

                case 66:
                    state.step = 110;
                    botTalk("Carga operacional:", 
                    ["Baja", "Media", "Alta"]);
                    break;

                //condiciones metereologicas
                case 67:
                    state.step = 68;
                    botTalk("Impacto percibido:", 
                    ["Bajo", "Medio", "Alto"]);
                    break;

                case 68:
                    state.step = 110;
                    botTalk("Informaci√≥n disponible:", 
                    ["Suficiente", "Parcial", "Insuficiente"]);
                    break;

                //continuacion NEAR MISS
                case 110:
                    state.step = 111;
                    botTalk("¬øQu√© evit√≥ que el accidente ocurriera?", 
                    ["Atenci√≥n / criterio", "Procedimiento / checklist", "Sistema t√©cnico / alerta", "Comunicaci√≥n", "Condiciones externas", "Casualidad"]);
                    break;

                case 111:
                    state.step = 112;
                    botTalk("Fragilidad de la barrera:", 
                    ["Fuerte y confiable", "Funcion√≥ con dificultad", "Funcion√≥ por poco", "Fue solo suerte"]);
                    break;

                case 112:
                    state.step = 113;
                    botTalk("Condiciones presentes (selecci√≥n m√∫ltiple):", //EDITAR****
                    ["Presi√≥n de tiempo", "Alta carga", "Fatiga", "Falta de personal", "Distracciones", "Meteo adversa", "Ninguna"]);
                    break;

                case 113:
                    state.step = 114;
                    botTalk("¬øFall√≥ alguna barrera previa?", 
                    ["Si", "No", "No estoy seguro"]);
                    break;

                case 114:
                    let falloBarrera = state.data['Paso_114'];
                    if(falloBarrera == "Si"){
                        state.step = 115;
                        botTalk("Indique cu√°l fue el fallo:", 
                        ["Procedimiento", "Comunicaci√≥n", "Supervisi√≥n", "Sistema t√©cnico"]);
                        break;
                    }else{
                        state.step = 116;
                        botTalk("Proximidad al accidente:", 
                        ["Segundos", "Minutos", "Con margen"]);
                        break;
                    }

                //continuacion
                case 115:
                    state.step = 116;
                    botTalk("Proximidad al accidente:", 
                    ["Segundos", "Minutos", "Con margen"]);
                    break;

                case 116:
                    state.step = 117;
                    botTalk("¬øHa ocurrido antes?", 
                    ["Frecuente", "Ha ocurrido", "Primera vez", "No lo s√©"]);
                    break;

                case 117:
                    state.step = 118;
                    botTalk("¬øPodr√≠a repetirse?", 
                    ["F√°cilmente", "En condiciones similares", "Dif√≠cil", "No deber√≠a"]);
                    break;

                case 118:
                    state.step = 119;
                    botTalk("Severidad potencial:", 
                    ["Menor", "Mayor", "Dif√≠cil", "Grave / catastr√≥fico"]);
                    break;

                case 119:
                    state.step = 120;
                    botTalk("Control actual del riesgo:", 
                    ["Controlado", "Parcial", "No controlado"]);
                    break;

                case 120:
                    state.step = 121;
                    botTalk("¬øQu√© deber√≠a cambiar para evitar la repetici√≥n?");
                    break;

                case 121:
                    state.step = 122;
                    botTalk("¬øInformado a jefatura/supervisi√≥n?:", 
                    ["S√≠", "No"]);
                    break;

                case 122:
                    console.log("Datos:", state.data);
                    botTalk("Gracias por tu reporte. <br>Los Near Miss permiten identificar debilidades del sistema <b>antes</b> de que se transformen en accidentes.");
                    break;

                //PELIGRO
                case 130:
                    let lugar = state.data['Paso_130'];
                    if(lugar == "Aer√≥dromo / Base operacional"){
                        state.step = 131;
                        botTalk("Aer√≥dromo donde se identifica el peligro");
                    }else{
                        state.step = 131;
                    }
                    break;

                case 131:
                    state.step = 132;
                    botTalk("Describa el peligro identificado.Indique claramente: <br>‚Ä¢ qu√© condici√≥n existe,<br>‚Ä¢ por qu√© representa un riesgo,<br>‚Ä¢ a qui√©n o qu√© podr√≠a afectar.<br>üìå No describa eventos ocurridos; conc√©ntrese solo en la condici√≥n peligrosa.")
                    break;

                case 132:
                    state.step = 133;
                    botTalk("Si este peligro no se controla, ¬øqu√© podr√≠a ocurrir?", [
                    "Lesi√≥n a personas", "Da√±o a la aeronave", "Da√±o a infraestructura", "Interrupci√≥n de la operaci√≥n", "Accidente grave", "Otro (describir)"]);
                    break;

                case 133:
                    state.step = 134;
                    botTalk("¬øQui√©nes podr√≠an verse afectados?", ["Tripulaci√≥n", "Personal de mantenimiento", "Personal de rampa", "Pasajeros", "Terceros", "M√°s de uno de los anteriores"]);
                    break;

                case 134:
                    state.step = 135;
                    botTalk(" ¬øCon qu√© frecuencia est√° presente este peligro?", ["Permanente", "Frecuente", "Ocasional", "Raro"]);
                    break;

                case 135:
                    state.step = 136;
                    botTalk("¬øEn qu√© condiciones se manifiesta principalmente?", ["Operaci√≥n normal", "Alta carga de trabajo", 
                    "Condiciones ambientales adversas", "Falta de personal", "Cambios de procedimiento", "Otro"]);

                case 136:
                    state.step = 137;
                    botTalk("¬øExisten controles o barreras actualmente?", ["Si", "No", "No estoy seguro"]);
                    break;

                case 137:
                    state.step = 138;
                    let respuesta = state.data['Paso_137'];
                    if(respuesta == "Si"){
                        botTalk("Tipo de barreras existentes", ["Procedimientos", "Capacitaci√≥n", "Supervisi√≥n", "Barreras t√©cnicas", "Se√±alizaci√≥n", "Experiencia del personal"]);
                    }
                    break;

                case 138:
                    state.step = 139;
                    botTalk("Desde su experiencia, los controles actuales son:", ["Adecuados", "Parcialmente adecuados", "Insuficientes", "No lo s√©"]);
                    break;

                case 139:
                    state.step = 140;
                    botTalk("Esta secci√≥n permite clasificar el peligro seg√∫n precursores OACI. Si tienes conocimiento del √°rea, selecciona la opci√≥n que mejor represente el origen del peligro.");
                    botTalk("Precursor OACI principal asociado al peligro (Seleccione el m√°s representativo)", 
                    ["Factor Humano (HF)", "Factor T√©cnico (TF)", "Factor Organizacional (OF)", "Factor Ambiental / Entorno (EF)", "Interfaz Humano‚ÄìSistema (HSI)", "No estoy seguro"]);
                    break;

                case 140:
                    state.step = 141;
                    botTalk(" Sub-precursor espec√≠fico (opcional, selecci√≥n m√∫ltiple)", 
                    ["Procedimiento inexistente o poco claro", "Procedimiento no aplicable a la realidad", "Capacitaci√≥n insuficiente", 
                    "Falta de experiencia", "Presi√≥n de tiempo / productividad", "Recursos insuficientes", "Supervisi√≥n limitada", "Dise√±o deficiente del proceso",
                    "Pr√°ctica informal normalizada", "Condiciones ambientales adversas"]);
                    break;

                case 141:   
                    state.step = 142;
                    botTalk("¬øEste precursor es recurrente en el √°rea?", ["S√≠, ocurre frecuentemente", "Ha ocurrido antes", "Es la primera vez", "No lo s√©"]);
                    break;

                case 142:
                    state.step = 143;
                    botTalk("Este peligro:", ["Apareci√≥ recientemente", "Existe desde hace tiempo", "Ha ido aumentando", "No estoy seguro"]);
                    break;

                case 143:
                    state.step = 144;
                    botTalk("¬øEste peligro ya ha generado incidentes, near miss u ocurrencias?", ["Si", "No", "No lo s√©"]);
                    break;

                case 144:
                    state.step = 145;
                    botTalk("Probabilidad percibida", ["Muy baja", "Baja", "Media", "Alta"]);
                    break;

                case 146:
                    state.step = 147;
                    botTalk("Severidad potencial", ["Menor", "Mayor", "Grave / catastr√≥fica"]);
                    break;

                case 147:
                    state.step = 148;
                    botTalk("Nivel de riesgo percibido", ["Bajo", "Medio", "Alto"]);
                    break;

                case 148:
                    state.step = 149;
                    botTalk("¬øQu√© acci√≥n preventiva ayudar√≠a a controlar este peligro?");
                    break;

                case 149:
                    state.step = 150;
                    botTalk("¬øEste peligro ha sido informado previamente?", ["Si", "No", "No lo s√©"]);
                    break;

                case 150:
                    state.step = 151;
                    botTalk("Gracias por identificar este peligro. Tu reporte contribuye directamente a la prevenci√≥n y al fortalecimiento de la seguridad operacional.");
                    break;
            }
        }

        // Funci√≥n auxiliar para saltar al bloque de riesgo (para no repetir c√≥digo)
        function goToRiskAssessment() {
            state.step = 40;
            botTalk("Evaluaci√≥n de Riesgo: ¬øCon qu√© frecuencia cree que esto podr√≠a volver a ocurrir?", 
                ["Muy poco probable", "Poco probable", "Ocasional", "Frecuente"]);
        }

        // --- INICIALIZACI√ìN ---
        // Manejar el bot√≥n de enviar
        function send() {
            const text = inputField.value.trim();
            handleInput(text, false);
        }

        // Permitir enviar con Enter
        inputField.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                send();
            }
        });

        // Arrancar el chat
        setTimeout(start, 500);

        /*const chat = document.getElementById("chat");
        let step = 0;
        let area = "";
        let categoria = "";
        let descripcion = "";

        function addMsg(text, cls) {
            const div = document.createElement("div");
            div.className = "msg " + cls;
            div.innerHTML = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function selectDepartamento() {
            setTimeout(() => {
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="operacionesSelect('Operaciones')">Aerov√≠as DAP - Operaciones</button>
                    <button onclick="sendDescripcion('Aeropuerto')">Aerov√≠as DAP - Aeropuerto</button>
                    <button onclick="mantenimientoSelect('Mantenimiento')">Aerov√≠as DAP - Mantenimiento</button>
                    <button onclick="operacionesSelect('Helos Operaciones')">DAP Helic√≥pteros - Operaciones</button>
                    <button onclick="mantenimientoSelect('Helos Mantenimiento')">DAP Helic√≥pteros - Mantenimiento</button>
                    <button onclick="sendDescripcion('Otra')">Otra √°rea de Aerov√≠as DAP</button>
                `;
                chat.appendChild(div);
            }, 500);
        }
        
        function operacionesSelect(area) {
            setTimeout(() => {
                addMsg(area, "user");
                addMsg("√Årea principal involucrada", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="bloqueOperacional('Tripulaci√≥n de Cabina')">Tripulaci√≥n de Cabina</button>
                    <button onclick="bloqueOperacional('Tripulaci√≥n de Vuelo')">Tripulaci√≥n de Vuelo</button>
                    <button onclick="bloqueOperacional('EOV')">EOV</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function mantenimientoSelect() {
            setTimeout(() => {
                addMsg("√Årea principal involucrada", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="bloqueOperacional('Produccion')">Producci√≥n</button>
                    <button onclick="bloqueOperacional('Control Calidad')">Control de Calidad</button>
                    <button onclick="bloqueOperacional('Sistema Calidad')">Sistema de Calidad</button>
                    <button onclick="bloqueOperacional('CAMO')">CAMO</button>
                    <button onclick="bloqueOperacional('Logistica')">Log√≠stica</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function bloqueOperacional(area){
            addMsg(area, "user");
            setTimeout(() => {
                addMsg("Fecha del Evento", "bot");
                step = 3;
            }, 500);
        }

        function addCategoriaOptions() {
            const div = document.createElement("div");
            div.className = "msg bot options";
            div.innerHTML = `
                <button onclick="selectCategoria('Ocurrencia')">Ocurrencia</button>
                <button onclick="selectCategoria('Incidente')">Incidente</button>
                <button onclick="selectCategoria('Near Miss')">Near Miss</button>
                <button onclick="selectCategoria('Peligro')">Peligro</button>
                <button onclick="selectCategoria('Mejora')">Mejora</button>
            `;
            chat.appendChild(div);
        }
    
        function send() {
            console.log(categoria)
            const input = document.getElementById("text");
            const text = input.value.trim();
            if (!text) return;

            addMsg(text, "user");
            input.value = "";

            // Paso 0: saludo
            if (step === 0/* && text.toLowerCase().includes("hola")) {
                setTimeout(() => {
                    addMsg(
                        "Hola. Gracias por comunicarte con nosotros.\n¬øQu√© tipo de incidente desea reportar?",
                        "bot"
                    );
                    addCategoriaOptions();
                    step = 1;
                }, 500);
                return;
            }

            if (step === 3) {
                descripcion = text;

                setTimeout(() => {
                    addMsg(
                        "Hora del Evento (UTC)",
                        "bot"
                    );
                    step = 4; 
                }, 500);
            }

            if (step === 4) {
                descripcion = text;

                setTimeout(() => {
                    addMsg(
                        "Aer√≥dromo de salida (AP/AD)",
                        "bot"
                    );
                    step = 5; 
                }, 500);
            }

            if(step === 5){
                descripcion = text;

                setTimeout(() => {
                    addMsg(
                        "Aer√≥dromo de llegada (AP/AD)",
                        "bot"
                    );
                    step = 6; 
                }, 500);
            }

            if(step === 6){
                descripcion = text;

                setTimeout(() => {
                    addMsg(
                        "Fase de vuelo",
                        "bot"
                    );
                    step = 7; 
                    faseDeVuelo();
                }, 500);

            }

            if(step == 8){
                descripcion = text;

                setTimeout(() => {
                    
                    if(categoria == "Ocurrencia"){
                        addMsg("¬øHubo personas lesionadas?", "bot");

                        const div = document.createElement("div");
                        div.className = "msg bot options";
                        div.innerHTML = `
                            <button onclick="lesionados('Si')">Si</button>
                            <button onclick="lesionados('No')">No</button>
                        `;
                        chat.appendChild(div);
                    }else if(categoria == "Incidente"){
                        addMsg("Tipo de situaci√≥n involucrada", "bot");

                        const div = document.createElement("div");
                        div.className = "msg bot options";
                        div.innerHTML = `
                            <button onclick="factorPrincipal('Configuraci√≥n incorrecta')">Configuraci√≥n incorrecta</button>
                            <button onclick="factorPrincipal('Error u omisi√≥n en procedimiento')">Error u omisi√≥n en procedimiento</button>
                            <button onclick="factorPrincipal('Falla o anomal√≠a t√©cnica')">Falla o anomal√≠a t√©cnica</button>
                            <button onclick="factorPrincipal('Problema de comunicaci√≥n')">Problema de comunicaci√≥n</button>
                            <button onclick="factorPrincipal('Condici√≥n operacional insegura')">Condici√≥n operacional insegura</button>
                            <button onclick="factorPrincipal('Otro (describir)')">Otro (describir)</button>
                        `;
                        chat.appendChild(div);
                    }
                
                }, 500);
            }

            if(step == 10){
                descripcion = text;

                setTimeout(() => {
                    addMsg("Gravedad de las lesiones", "bot");
                    const div = document.createElement("div");
                    div.className = "msg bot options";
                    div.innerHTML = `
                        <button onclick="danosMateriales('Leve')">Leve</button>
                        <button onclick="danosMateriales('Grave')">Grave</button>
                        <button onclick="danosMateriales('Fatal')">Fatal</button>
                    `;
                    chat.appendChild(div);
                }, 500);
            }
            
            if(step == 12){
                descripcion = text;

                setTimeout(() => {
                    addMsg(
                        "¬øSe interrumpi√≥ la operaci√≥n?",
                        "bot"
                    );
                    const div = document.createElement("div");
                    div.className = "msg bot options";
                    div.innerHTML = `
                        <button onclick="interrupcion('Si')">Si</button>
                        <button onclick="interrupcion('No')">No</button>
                    `;
                    chat.appendChild(div);
                    step = 0; 
                }, 500);
            }

            if(step == 13){
                descripcion = text;

                setTimeout(() => {
                    incidenteDetectado();
                }, 500);
            }
        }

        function selectCategoria(cat) {
            if (step !== 1) return;
            categoria = cat;
            addMsg(categoria, "user");

            setTimeout(() => {
                if (categoria === "Ocurrencia") {
                    addMsg("Est√°s a punto de reportar una <b>OCURRENCIA.</b><br> Si tienes dudas, puedes consultar qu√© significa este tipo de reporte en cualquier momento.", "bot");
                    addMsg("¬øA qu√© departamento pertenece la ocurrencia?", "bot");
                    selectDepartamento();
                }else if(categoria === "Incidente"){
                    addMsg("Est√°s a punto de reportar un <b>INCIDENTE.</b><br> Si tienes dudas, puedes consultar qu√© significa este tipo de reporte en cualquier momento.", "bot");
                    addMsg("¬øA qu√© departamento pertenece el incidente?", "bot");
                    selectDepartamento();
                }
            }, 500);
        }

        function faseDeVuelo(){
            const div = document.createElement("div");
            div.className = "msg bot options";
            div.innerHTML = `
                <button onclick="faseVuelo('Estacionamiento')">Estacionamiento</button>
                <button onclick="faseVuelo('Rodaje de Salida')">Rodaje de Salida</button>
                <button onclick="faseVuelo('Despegue')">Despegue</button>
                <button onclick="faseVuelo('Ascenso')">Ascenso</button>
                <button onclick="faseVuelo('Crucero')">Crucero</button>
                <button onclick="faseVuelo('Descenso')">Descenso</button>
                <button onclick="faseVuelo('Aproximacion')">Aproximaci√≥n</button>
                <button onclick="faseVuelo('Aterrizaje')">Aterrizaje</button>
                <button onclick="faseVuelo('Rodaje de Llegada')">Rodaje de Llegada</button>
                <button onclick="faseVuelo('Post-Vuelo')">Post-Vuelo</button>
            `;
            chat.appendChild(div);
        }

        function faseVuelo(fase) {
            addMsg(fase, "user");

            setTimeout(() => {
                addMsg(
                    "Lugar donde ocurri√≥ el evento",
                    "bot"
                );
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="matricula('Plataforma')">Plataforma</button>
                    <button onclick="matricula('Pista')">Pista</button>
                    <button onclick="matricula('Calle de Rodaje')">Calle de Rodaje</button>
                    <button onclick="matricula('En Ruta')">En Ruta</button>
                    <button onclick="matricula('Hangar')">Hangar</button>
                    <button onclick="matricula('Instalaciones CMA')">Instalaciones CMA</button>
                    <button onclick="matricula('Otro')">Otro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function matricula(lugar){
            addMsg(lugar, "user");

            setTimeout(() => {
                addMsg(
                    "Matr√≠cula de la Aeronave", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="sendDescripcion('CC-ACN')">CC-ACN</button>
                    <button onclick="sendDescripcion('CC-ACO')">CC-ACO</button>
                    <button onclick="sendDescripcion('CC-ACQ')">CC-ACQ</button>`;  
                chat.appendChild(div);
            }, 500);
        }

        function sendDescripcion(matricula){
            if(matricula){
                addMsg(matricula, "user");
            }-
            setTimeout(() => {
                addMsg(
                    "Indique qu√© ocurri√≥, c√≥mo se desarroll√≥ el evento y cualquier antecedente relevante.",
                    "bot"
                );
                step = 8; 
            }, 500);
        }

        function lesionados(respuesta){
            addMsg(respuesta, "user");

            setTimeout(() => {
                if(respuesta === "Si"){
                    addMsg("Cantidad de lesionados", "bot");
                    step = 10; 
                }
                else{
                    probabilidadPercibida(

                    );
                }
                
            }, 500);
        }


        function danosMateriales(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øHubo da√±os materiales?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="tipoDanoMaterial('Si')">Si</button>
                    <button onclick="probabilidadPercibida('No')">No</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function tipoDanoMaterial(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Tipo de da√±o material", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="probabilidadPercibida('Aeronave')">Aeronave</button>
                    <button onclick="probabilidadPercibida('Infraestructura')">Infraestructura</button>
                    <button onclick="probabilidadPercibida('Equipos y Herramientas')">Equipos y Herramientas</button>
                    <button onclick="probabilidadPercibida('Otro')">Otro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function probabilidadPercibida(respuesta){
            if(respuesta){
                addMsg(respuesta, "user");
            }
            setTimeout(() => {
                addMsg("Desde su experiencia, ¬øcon qu√© frecuencia cree que este evento podr√≠a volver a ocurrir si no se toman medidas?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="severidadPercibida('Muy poco probable')">Muy poco probable</button>
                    <button onclick="severidadPercibida('Poco probable')">Poco probable</button>
                    <button onclick="severidadPercibida('Ocasional')">Ocasional</button>
                    <button onclick="finalizaseveridadPercibidarReporte('Frecuente')">Frecuente</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function severidadPercibida(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Si este evento se repite, ¬øqu√© nivel de consecuencia podr√≠a tener?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="nivelRiesgo('Sin impacto relevante')">Sin impacto relevante</button>
                    <button onclick="nivelRiesgo('Impacto menor')">Impacto menor</button>
                    <button onclick="nivelRiesgo('Impacto mayor')">Impacto mayor</button>
                    <button onclick="nivelRiesgo('Impacto grave')">Impacto grave</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function nivelRiesgo(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Considerando lo ocurrido, usted dir√≠a que el riesgo asociado a este evento es:", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="urgenciaAccion('Bajo')">Bajo</button>
                    <button onclick="urgenciaAccion('Medio')">Medio</button>
                    <button onclick="urgenciaAccion('Alto')">Alto</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function urgenciaAccion(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øConsidera que este evento requiere acciones correctivas inmediatas?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="propuestaReportante('Si')">Si</button>
                    <button onclick="propuestaReportante('No')">No</button>
                    <button onclick="propuestaReportante('No estoy seguro')">No estoy seguro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function propuestaReportante(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Desde su punto de vista, ¬øqu√© acci√≥n ayudar√≠a a evitar que este evento vuelva a ocurrir?", "bot");
                step = 12;
            }, 500);
        }

        function interrupcion(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øSe aplic√≥ alguna acci√≥n inmediata?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="eventoInformado('Si')">Si</button>
                    <button onclick="eventoInformado('No')">No</button>
                `;
                chat.appendChild(div);
            }, 500);
        }
        
        function eventoInformado(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øEl evento fue informado a jefatura o supervisi√≥n?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="finalizar('Si')">Si</button>
                    <button onclick="finalizar('No')">No</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function finalizar(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Gracias por reportar la ocurrencia. Su reporte ha sido registrado con √©xito.", "bot");
            }, 500);
        }

        function factorPrincipal(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg(" Factor principal involucrado (a su juicio)", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="etapaIncidente('Factor humano')">Factor humano</button>
                    <button onclick="etapaIncidente('Factor t√©cnico')">Factor t√©cnico</button>
                    <button onclick="etapaIncidente('Factor organizacional')">Factor organizacional</button>
                    <button onclick="etapaIncidente('Condiciones ambientales')">Condiciones ambientales</button>
                    <button onclick="etapaIncidente('No estoy seguro')">No estoy seguro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function etapaIncidente(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Etapa en la que se produjo el incidente", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="desviacionProcedimiento('Antes de la operaci√≥n')">Antes de la operaci√≥n</button>
                    <button onclick="desviacionProcedimiento('Durante la operaci√≥n')">Durante la operaci√≥n</button>
                    <button onclick="desviacionProcedimiento('Despu√©s de la operaci√≥n')">Despu√©s de la operaci√≥n</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function desviacionProcedimiento(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øHubo desviaci√≥n de procedimientos?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="describirDesviacion('Si')">Si</button>
                    <button onclick="incidenteDetectado('No')">No</button>
                    <button onclick="incidenteDetectado('No estoy seguro')">No estoy seguro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function describirDesviacion(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("Describa la desviaci√≥n de procedimiento", "bot");
                step = 13; 
            }, 500);
        }

        function incidenteDetectado(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øC√≥mo fue detectado el incidente?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="evitoIncidente('Autodetecci√≥n')">Autodetecci√≥n</button>
                    <button onclick="evitoIncidente('Otro miembro del equipo')">Otro miembro del equipo</button>
                    <button onclick="evitoIncidente('Superviso/Jefatura')">Supervisor / Jefatura</button>
                    <button onclick="evitoIncidente('Sistema / Alarma')">Sistema / Alarma</button>
                    <button onclick="evitoIncidente('Auditor√≠a / Inspecci√≥n')">Auditor√≠a / Inspecci√≥n</button>
                    <button onclick="evitoIncidente('Otro')">Otro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function evitoIncidente(respuesta){
            addMsg(respuesta, "user");
            setTimeout(() => {
                addMsg("¬øQu√© evit√≥ que el incidente escalara?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="huboLesionados('Procedimiento')">Procedimiento</button>
                    <button onclick="huboLesionados('Experiencia / criterio del personal')">Experiencia / criterio del personal</button>
                    <button onclick="huboLesionados('Sistema t√©cnico')">Sistema t√©cnico</button>
                    <button onclick="huboLesionados('Comunicaci√≥n efectiva')">Comunicaci√≥n efectiva</button>
                    <button onclick="huboLesionados('Condiciones externas favorables')">Condiciones externas favorables</button>
                    <button onclick="huboLesionados('No aplica / No estoy seguro')">No aplica / No estoy seguro</button>
                `;
                chat.appendChild(div);
            }, 500);
        }

        function huboLesionados(respuesta){
            addMsg(respuesta, "user");
           
            setTimeout(() => {
                addMsg("¬øHubo personas lesionadas?", "bot");
                const div = document.createElement("div");
                div.className = "msg bot options";
                div.innerHTML = `
                    <button onclick="lesionados('Si')">Si</button>
                    <button onclick="lesionados('No')">No</button>
                `;
                chat.appendChild(div);
            }, 500);
        }*/
</script>




    <link rel="stylesheet" type="text/css" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </body>
</html>
